<!DOCTYPE html>

<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Place order</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- <link rel="stylesheet" href="./style.css"> -->
        <style>
          body{
            background-color: black;
        }
        
        table, th, td {
            border: 2px dotted white;
            border-collapse: collapse;
        }
        
        .header{
            color: white;
            padding: 1% 1%;
            margin-left: 5%;
        }
        
        #buyorder{
            min-width: 50%;
        }
        
        #sellorder{
            min-width: 50%;
        }
        
        h2{
            color: aliceblue;
        }
        
        label{
            color: white;
            margin: 10px;
        }
        
        input{
            margin: 10px;
        }
        
        td{
            color: aliceblue;
        }
        
        .list{
            margin: 50px
        }
        </style>
    </head>
    <body onload="main()">
       <form action="" onsubmit="">
            <div>
                <label for="">Price</label>
                <input type="text" name="price" id="price">
            </div>
            <div>
                <label for="">Qty</label>
                <input type="text" name="qty" id="qty">
            </div>
            <input type="button" value="Place order" onclick="onFormSubmit()">
            <input type="button" name="" onclick="updateValue()" value="update">
            <input type="button" value="delete" onclick="myDeleteFunction()">
       </form>

        <div>
            <h2>
              Buy Order
            </h2>
          </div>
          <table class="list" id="buyorder">
            <thead>
                <tr>
                    <th class="header">Price</th>
                    <th class="header">Qty</th>
                    <th class="header">Total</th>
                </tr>
            </thead>
            <tbody>
              <!-- <tr data-index="2" >
              </tr> -->
            </tbody>
        </table>
        <div>
          <h2>
            Sell Order
          </h2>
        </div>
        <table class="list" id="sellorder">
          <thead>
              <tr>
                  <th class="header">Price</th>
                  <th class="header">Qty</th>
                  <th class="header">Total</th>
              </tr>
          </thead>
          <tbody>
    
          </tbody>
      </table>


      <!-- <script
    src="https://cdnjs.cloudflare.com/ajax/libs/qs/6.9.2/qs.min.js"
    integrity="sha256-TDxXjkAUay70ae/QJBEpGKkpVslXaHHayklIVglFRT4="
    crossorigin="anonymous"
    ></script> -->
    
    <!-- 
    <script srv="http://localhost:3344/socket.io/socket.io.js"></script> -->
    <!-- <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script> -->
      <!-- <script src="../server.js"></script> -->


      <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
      <script src="http://localhost:3344/socket.io/socket.io.js"></script>
      <script>
            //socket init
            var socket = io()
           
            console.log(socket)
            socket.on('message', (data) =>{
                console.log("++++ event received ++++")
                console.log(" ======= message =======",data)
                //document.location.reload();
             })



             function onFormSubmit(){
              var result = readform()
              socket.emit("message",insertNewRecord(result))
              console.log(result['price'])
              console.log(result['qty'])
            }



            function readform(){
              var data ={}
              data['price']= document.getElementById('price').value
              data['qty'] = document.getElementById('qty').value
              console.log(data["price"])
              console.log(data["qty"])   
              return data
            }


            async function insertNewRecord(data){
                  var table = document.getElementById("buyorder").getElementsByTagName('tbody')[0];
                  var result = await getBuyOrderInsertPosition(data);
                  console.log("insert postion ===",result["insert_position"]);
                  var newRow = table.insertRow(result["insert_position"]-1);
                  cell1 = newRow.insertCell(0);
                  cell1.innerHTML = data["price"];
                  cell2 = newRow.insertCell(1);
                  cell2.innerHTML = data["qty"];
                  cell3 = newRow.insertCell(2);
                  cell3.innerHTML = data["price"] * data["qty"];

                 await postData(data)
                 socket.emit("message",{"message":"insert event received"})
                 clearFields();
                
            }

              //delete @ specific index
              function myDeleteFunction() {
               
                document.getElementById("buyorder").deleteRow(5);
              }

            function clearFields(){
              document.getElementById('price').value = ''
              document.getElementById('qty').value=''
            }
            

            // function to get from sql database
            async function fetchData () {
              let response = await fetch("http://localhost:3344/api/buyorder/getbuyorder");
              let data = await response.json();
              for (var i = 0; i < data.length; i++){
                    var table = document.getElementById("buyorder").getElementsByTagName('tbody')[0];
                    var newRow = table.insertRow(0);
                    cell1 = newRow.insertCell(0);
                    cell1.innerHTML = data[i]["price"];
                    cell2 = newRow.insertCell(1);
                    cell2.innerHTML = data[i]["qty"];
                    cell3 = newRow.insertCell(2);
                    cell3.innerHTML = data[i]["price"] * data[i]["qty"];
              }
              console.log(data)
              return data;
            }
            
            //function to add buy order to sql database

            async function postData(data){
              const response = await fetch("http://localhost:3344/api/buyorder/addbuyorder", {
                method: 'POST',
                headers: {
                  'Accept': 'application/json',
                  'Content-Type': 'application/json'
                },
                body: `{
                  "qty": ${data['qty']},
                  "price": ${data['price']},
                  "total_price": ${data['qty'] * data['price']}
                  }`,
                });
                
                response.json().then(data => {
                  console.log(data);
                });
            }

            async function getBuyOrderInsertPosition(data) {
              const response = await fetch("http://localhost:3344/api/buyorder/insert", {
                method: 'POST',
                headers: {
                  'Accept': 'application/json',
                  'Content-Type': 'application/json'
                },
                body: `{
                  "price": ${data['price']},
                  "qty":${data['qty']}
                  }`,
                });
                
                //response.json().then(d => {
                 // console.log("+++++ insert position +++ ",d['insert_position']+1)
                  //var inser_pos = d['insert_position'];
                  //console.log("==== from insert new record function  ===== ",inser_pos)
               // });
               //console.log(response.json());
               return response.json();
            }

            function updateValue(){  
              var table = document.getElementById("buyorder").getElementsByTagName('tbody')[0];
              var newRow = table.insertRow(10);
              cell1 = newRow.insertCell(0);
              cell1.innerHTML = 8888;
              cell2 = newRow.insertCell(1);
              cell2.innerHTML = 8888;
              cell3 = newRow.insertCell(2);
              cell3.innerHTML = 8888 * 8888;
            }

            async function main(){
              await fetchData()
            }
      </script>
    </body>
</html>